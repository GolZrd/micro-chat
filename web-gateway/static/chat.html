<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
        <div class="chat-header">
            <div>
                <h1>üí¨ –ß–∞—Ç #<span id="chatIdDisplay">...</span></h1>
            </div>
            <div class="user-badge">
                –í—ã: <strong id="currentUsername">–∑–∞–≥—Ä—É–∑–∫–∞...</strong>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div id="connectionStatus" class="status-badge status-disconnected">
            üî¥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
        </div>
        
        <div class="chat-container">
            <!-- –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div id="messages" class="messages"></div>
            
            <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–ë–ï–ó –ø–æ–ª—è username!) -->
            <form id="messageForm" class="message-form">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                    required 
                    autocomplete="off"
                >
                <button type="submit" id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
        
        <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º app.js -->
    <script src="/static/app.js"></script>
    <script>
        // ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====================
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (!TokenManager.isAuthenticated()) {
            alert('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É!');
            window.location.href = '/';
        }

        // –ü–æ–ª—É—á–∞–µ–º chat ID –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('id');
        
        if (!chatId) {
            alert('‚ùå Chat ID –Ω–µ —É–∫–∞–∑–∞–Ω!');
            window.location.href = '/';
        }

        document.getElementById('chatIdDisplay').textContent = chatId;

        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏ username
        const token = TokenManager.getAccessToken();
        const currentUsername = TokenManager.getUsername() || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        document.getElementById('currentUsername').textContent = currentUsername;

        console.log('üë§ Current user:', currentUsername);

        // ==================== WebSocket ====================
        
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const cleanToken = token.replace('Bearer ', '').trim();
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/chat/${chatId}?token=${encodeURIComponent(cleanToken)}`;
        
        console.log('üîå Connecting to WebSocket...');
        
        let ws = new WebSocket(wsUrl);
        const statusEl = document.getElementById('connectionStatus');
        const sendBtn = document.getElementById('sendBtn');

        ws.onopen = () => {
            console.log('‚úÖ WebSocket connected');
            statusEl.textContent = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            statusEl.className = 'status-badge status-connected';
            sendBtn.disabled = false;
        };

        ws.onmessage = (event) => {
            console.log('üì® Received:', event.data);
            
            try {
                const msg = JSON.parse(event.data);
                
                if (msg.error) {
                    console.error('‚ùå Server error:', msg.error);
                    statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + msg.error;
                    statusEl.className = 'status-badge status-disconnected';
                    return;
                }
                
                displayMessage(msg);
            } catch (error) {
                console.error('‚ùå Parse error:', error);
            }
        };

        ws.onerror = (error) => {
            console.error('‚ùå WebSocket error:', error);
            statusEl.textContent = 'üî¥ –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            statusEl.className = 'status-badge status-disconnected';
            sendBtn.disabled = true;
        };

        ws.onclose = (event) => {
            console.log('üîå WebSocket closed');
            statusEl.textContent = 'üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            statusEl.className = 'status-badge status-disconnected';
            sendBtn.disabled = true;
            
            setTimeout(() => location.reload(), 3000);
        };

        // ==================== –§—É–Ω–∫—Ü–∏–∏ ====================

        function displayMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            
            const isOwn = msg.from === currentUsername;
            if (isOwn) msgDiv.classList.add('own');
            
            let timeStr = '—Å–µ–π—á–∞—Å';
            if (msg.createdAt) {
                try {
                    const date = new Date(msg.createdAt);
                    if (!isNaN(date.getTime())) {
                        timeStr = date.toLocaleTimeString('ru-RU', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                } catch (e) {}
            }
            
            msgDiv.innerHTML = `
                <div class="message-header">
                    <strong>${escapeHtml(msg.from || '–ê–Ω–æ–Ω–∏–º')}</strong>
                    <span class="time">${timeStr}</span>
                </div>
                <div class="message-text">${escapeHtml(msg.text || '')}</div>
            `;
            
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== –û—Ç–ø—Ä–∞–≤–∫–∞ ====================

        document.getElementById('messageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            
            if (!text) return;
            
            sendBtn.disabled = true;
            sendBtn.textContent = '‚è≥';
            
            try {
                const response = await apiRequest('/api/chat/send', {
                    method: 'POST',
                    body: JSON.stringify({
                        chat_id: parseInt(chatId),
                        text: text
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to send');
                }
                
                messageInput.value = '';
                
            } catch (error) {
                console.error('‚ùå Send error:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            }
        });

        // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('messageForm').dispatchEvent(new Event('submit'));
            }
        });

        window.addEventListener('load', () => {
            document.getElementById('messageInput').focus();
        });
    </script>
</body>
</html>