<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room - Micro Chat</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="chat-app-container">
        <!-- Ğ›ĞµĞ²Ğ°Ñ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ - Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‡Ğ°Ñ‚Ğ¾Ğ² -->
        <aside class="chat-list-sidebar">
            <div class="sidebar-header">
                <button onclick="window.location.href='/'" class="home-btn" title="ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h3>ĞœĞ¾Ğ¸ Ñ‡Ğ°Ñ‚Ñ‹</h3>
                <button onclick="refreshChatList()" class="refresh-btn" title="ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <div class="current-chat-info">
                <div class="chat-status">
                    <span class="status-dot active"></span>
                    <div>
                        <strong>Ğ§Ğ°Ñ‚ <span id="currentChatId"></span></strong>
                        <small id="connectionStatus">ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾</small>
                    </div>
                </div>
            </div>
            
            <div class="other-chats">
                <div class="section-title">Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ Ñ‡Ğ°Ñ‚Ñ‹</div>
                <div id="chatsList" class="chats-list">
                    <div class="loading-chats">
                        <i class="fas fa-spinner fa-spin"></i>
                        Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ‡Ğ°Ñ‚Ğ¾Ğ²...
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-info-mini">
                    <i class="fas fa-user-circle"></i>
                    <span id="currentUser">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</span>
                </div>
            </div>
        </aside>
        
        <!-- Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ - Ğ§Ğ°Ñ‚ -->
        <main class="chat-main-area">
            <div class="chat-header">
                <button class="mobile-menu-btn" onclick="toggleLeftSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="chat-title">
                    <h2>Ğ§Ğ°Ñ‚ <span id="chatIdDisplay">...</span></h2>
                    <div class="chat-meta">
                        <span id="messageCount">0 ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹</span>
                        <span class="separator">â€¢</span>
                        <span id="onlineCount">0 Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½</span>
                    </div>
                </div>
                <button class="mobile-members-btn" onclick="toggleRightSidebar()">
                    <i class="fas fa-users"></i>
                </button>
            </div>
            
            <div class="messages-wrapper">
                <div id="messages" class="messages">
                    <div class="welcome-message">
                        <i class="fas fa-comments"></i>
                        <h3>Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ñ‡Ğ°Ñ‚!</h3>
                        <p>ĞĞ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€ÑĞ¼Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ</p>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span class="typing-text">ĞºÑ‚Ğ¾-Ñ‚Ğ¾ Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ°ĞµÑ‚...</span>
                </div>
            </div>
            
            <div class="message-input-area">
                <form id="messageForm" class="message-form">
                    <div class="input-left-actions">
                        <button type="button" class="emoji-btn" title="Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸">
                            <i class="far fa-smile"></i>
                        </button>
                    </div>
                    
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            name="message" 
                            placeholder="ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..."
                            rows="1"
                            maxlength="2000"
                        ></textarea>
                    </div>
                    
                    <div class="input-right-actions">
                        <button type="button" class="input-action-btn" title="ĞŸÑ€Ğ¸ĞºÑ€ĞµĞ¿Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button type="button" class="input-action-btn" title="GIF">
                            <i class="fas fa-gift"></i>
                        </button>
                        <button type="submit" class="send-btn" title="ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
                
                <div class="input-info">
                    <div class="input-hints">
                        <span class="input-hint">
                            <kbd>Enter</kbd> Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ
                        </span>
                        <span class="input-hint">
                            <kbd>Shift</kbd>+<kbd>Enter</kbd> Ğ½Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ°
                        </span>
                    </div>
                    <span class="char-counter">
                        <span id="charCount">0</span>/2000
                    </span>
                </div>
                
                <!-- Emoji Picker -->
                <div class="emoji-picker">
                    <div class="emoji-header">
                        <input type="text" class="emoji-search" placeholder="ĞŸĞ¾Ğ¸ÑĞº ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸...">
                    </div>
                    <div class="emoji-categories">
                        <button type="button" class="emoji-category active">ğŸ˜Š</button>
                        <button type="button" class="emoji-category">ğŸ‘‹</button>
                        <button type="button" class="emoji-category">ğŸŒ¸</button>
                        <button type="button" class="emoji-category">ğŸ•</button>
                        <button type="button" class="emoji-category">âš½</button>
                        <button type="button" class="emoji-category">âœˆï¸</button>
                        <button type="button" class="emoji-category">ğŸ’¡</button>
                        <button type="button" class="emoji-category">â¤ï¸</button>
                    </div>
                    <div class="emoji-grid">
                        <span>ğŸ˜€</span><span>ğŸ˜ƒ</span><span>ğŸ˜„</span><span>ğŸ˜</span>
                        <span>ğŸ˜…</span><span>ğŸ˜‚</span><span>ğŸ¤£</span><span>ğŸ˜Š</span>
                        <span>ğŸ˜‡</span><span>ğŸ™‚</span><span>ğŸ™ƒ</span><span>ğŸ˜‰</span>
                        <span>ğŸ˜Œ</span><span>ğŸ˜</span><span>ğŸ¥°</span><span>ğŸ˜˜</span>
                        <span>ğŸ˜—</span><span>ğŸ˜™</span><span>ğŸ˜š</span><span>ğŸ˜‹</span>
                        <span>ğŸ˜›</span><span>ğŸ˜</span><span>ğŸ˜œ</span><span>ğŸ¤ª</span>
                        <span>ğŸ¤¨</span><span>ğŸ§</span><span>ğŸ¤“</span><span>ğŸ˜</span>
                        <span>ğŸ¤©</span><span>ğŸ¥³</span><span>ğŸ˜</span><span>ğŸ˜’</span>
                        <span>ğŸ˜</span><span>ğŸ˜”</span><span>ğŸ˜Ÿ</span><span>ğŸ˜•</span>
                        <span>ğŸ™</span><span>â˜¹ï¸</span><span>ğŸ˜£</span><span>ğŸ˜–</span>
                        <span>ğŸ˜«</span><span>ğŸ˜©</span><span>ğŸ¥º</span><span>ğŸ˜¢</span>
                        <span>ğŸ˜­</span><span>ğŸ˜¤</span><span>ğŸ˜ </span><span>ğŸ˜¡</span>
                        <span>ğŸ¤¬</span><span>ğŸ¤¯</span><span>ğŸ˜³</span><span>ğŸ¥µ</span>
                        <span>ğŸ¥¶</span><span>ğŸ˜±</span><span>ğŸ˜¨</span><span>ğŸ˜°</span>
                        <span>ğŸ˜¥</span><span>ğŸ˜“</span><span>ğŸ¤—</span><span>ğŸ¤”</span>
                        <span>ğŸ¤­</span><span>ğŸ¤«</span><span>ğŸ¤¥</span><span>ğŸ˜¶</span>
                        <span>ğŸ˜</span><span>ğŸ˜‘</span><span>ğŸ˜¬</span><span>ğŸ™„</span>
                        <span>ğŸ˜¯</span><span>ğŸ˜¦</span><span>ğŸ˜§</span><span>ğŸ˜®</span>
                        <span>ğŸ‘</span><span>ğŸ‘</span><span>ğŸ‘Œ</span><span>âœŒï¸</span>
                        <span>ğŸ¤</span><span>ğŸ¤Ÿ</span><span>ğŸ¤˜</span><span>ğŸ¤™</span>
                        <span>ğŸ‘</span><span>ğŸ™Œ</span><span>ğŸ‘</span><span>ğŸ¤²</span>
                        <span>ğŸ¤</span><span>ğŸ™</span><span>âœï¸</span><span>ğŸ’ª</span>
                        <span>â¤ï¸</span><span>ğŸ§¡</span><span>ğŸ’›</span><span>ğŸ’š</span>
                        <span>ğŸ’™</span><span>ğŸ’œ</span><span>ğŸ–¤</span><span>ğŸ¤</span>
                        <span>ğŸ”¥</span><span>ğŸ’¯</span><span>âœ¨</span><span>â­</span>
                    </div>
                </div>
            </div>
        </main>
         <!-- ĞŸÑ€Ğ°Ğ²Ñ‹Ğ¹ sidebar - Ğ£Ğ§ĞĞ¡Ğ¢ĞĞ˜ĞšĞ˜ -->
        <aside class="right-sidebar right-sidebar--members">
            <div class="sidebar-header">
                <h3><i class="fas fa-users"></i> Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸</h3>
                <span class="badge" id="totalMembers">0</span>
            </div>

            <div class="sidebar-content">
                <div id="membersList" class="members-list">
                    <div class="member-item">
                        <div class="member-avatar">
                            <i class="fas fa-user-circle"></i>
                            <span class="online-indicator"></span>
                    </div>
                    <div class="member-info">
                        <strong>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</strong>
                        <small>ĞĞ½Ğ»Ğ°Ğ¹Ğ½</small>
                    </div>
                </div>
                </div>
            </div>
        </aside>
    </div>

    <script src="/static/app.js"></script>
    <!-- <script src="/static/js/chat-transparency.js"></script> -->
    <!-- ĞŸĞµĞ²Ğ°Ñ Ñ‚ĞµĞ¼Ğ° -->
    <!-- <script src="/static/js/animated-background.js"></script> -->
    <!-- Ğ”Ğ»Ñ Liquid Gradient -->
    <script src="/static/js/liquid-gradient.js"></script>

    <!-- Ğ”Ğ»Ñ Starfall -->
    <!-- <script src="/static/js/starfall.js"></script> -->

    <script>
        // ==================== CHAT PAGE LOGIC ====================
        console.log('ğŸ® Chat page script loading...');
        
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('id');
        
        if (!chatId) {
            alert('âŒ Chat ID Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½!');
            window.location.href = '/';
            throw new Error('No chat ID');
        }

        if (!TokenManager.isAuthenticated()) {
            alert('âŒ ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ!');
            window.location.href = '/';
            throw new Error('Not authenticated');
        }

        console.log('âœ… Chat ID:', chatId);
        
        const token = TokenManager.getAccessToken();
        const currentUsername = TokenManager.getUsername() || 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ';
        let messageCount = 0;

        let onlineUsersSet = new Set(); // Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ¼ Ğ¸Ğ¼ĞµĞ½Ğ° Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹

        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ID ÑÑ€Ğ°Ğ·Ñƒ
        document.getElementById('currentChatId').textContent = chatId;
        document.getElementById('chatIdDisplay').textContent = `#${chatId}`;
        document.getElementById('currentUser').textContent = currentUsername;

        // ==================== WEBSOCKET ====================
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const cleanToken = token.replace('Bearer ', '').trim();
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/chat/${chatId}?token=${encodeURIComponent(cleanToken)}`;
        
        console.log('ğŸ”Œ Connecting to:', wsUrl.replace(cleanToken, 'TOKEN'));
        
        function connectWebSocket() {
            window.socket = new WebSocket(wsUrl);
            
            window.socket.onopen = () => {
                console.log('âœ… WebSocket connected');
                updateConnectionStatus(true);
            };

            window.socket.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    console.log('ğŸ“¨ Message:', msg);
                    
                    if (msg.error) {
                        console.error('âŒ Error:', msg.error);
                        return;
                    }
                    
                    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
                    if (msg.type === 'online_users') {
                        console.log('ğŸ‘¥ Online users update:', msg);
                        updateOnlineStatus(msg.onlineUsers || [], msg.onlineCount || 0);
                        return;
                    }
                    
                    // ĞĞ±Ñ‹Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ (type === 'message' Ğ¸Ğ»Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚)
                    if (msg.from !== undefined && msg.text !== undefined) {
                        displayMessage(msg);
                    } else {
                        console.warn('âš ï¸ Unknown message format:', msg);
                    }
                } catch (error) {
                    console.error('âŒ Parse error:', error);
                }
            };

            window.socket.onerror = (error) => {
                console.error('âŒ WebSocket error:', error);
                updateConnectionStatus(false);
            };

            window.socket.onclose = () => {
                console.log('ğŸ”Œ Closed, reconnecting...');
                updateConnectionStatus(false);
                setTimeout(connectWebSocket, 3000);
            };
        }

        function displayMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const welcome = messagesDiv.querySelector('.welcome-message');
            if (welcome) welcome.remove();
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            
            const isOwn = msg.from === currentUsername;
            if (isOwn) msgDiv.classList.add('own');
            
            const textLength = msg.text ? msg.text.length : 0;
            let sizeClass = '';
            if (textLength <= 3) sizeClass = 'tiny';
            else if (textLength <= 20) sizeClass = 'short';
            else if (textLength > 200) sizeClass = 'long';
            
            const timeStr = new Date().toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            msgDiv.innerHTML = `
                <div class="message-header">
                    <strong>${escapeHtml(msg.from)}</strong>
                    <span class="time">${timeStr}</span>
                </div>
                <div class="message-text ${sizeClass}">${escapeHtml(msg.text || '')}</div>
            `;
            
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            messageCount++;
            document.getElementById('messageCount').textContent = `${messageCount} ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateConnectionStatus(isConnected) {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.getElementById('connectionStatus');
            const sendBtn = document.querySelector('.send-btn');
            
            if (isConnected) {
                if (statusDot) statusDot.classList.add('active');
                if (statusText) statusText.textContent = 'ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾';
                if (sendBtn) sendBtn.disabled = false;
            } else {
                if (statusDot) statusDot.classList.remove('active');
                if (statusText) statusText.textContent = 'ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾';
                if (sendBtn) sendBtn.disabled = true;
            }
        }

        async function loadChatsList() {
            try {
                const response = await apiRequest('/api/chat/my');
                const data = await response.json();
                
                if (!response.ok) {
                    console.error('Load chats failed:', data.error);
                    return;
                }
                
                let chats = data.chats || [];
                chats = chats.filter(chat => chat && chat.id && chat.id != chatId);
                
                const chatsListEl = document.getElementById('chatsList');
                
                if (chats.length === 0) {
                    chatsListEl.innerHTML = '<p class="no-chats">ĞĞµÑ‚ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ñ‡Ğ°Ñ‚Ğ¾Ğ²</p>';
                    return;
                }
                
                let html = '';
                chats.forEach(chat => {
                    const users = chat.usernames || [];
                    const chatItemName = chat.name || `Ğ§Ğ°Ñ‚ #${chat.id}`;
                    html += `
                        <a href="/chat?id=${chat.id}" class="chat-item">
                            <div class="chat-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="chat-info">
                                <strong>${escapeHtml(chatItemName)}</strong>
                                <small>${users.slice(0, 2).join(', ')}${users.length > 2 ? '...' : ''}</small>
                            </div>
                        </a>
                    `;
                });
                
                chatsListEl.innerHTML = html;
                console.log('âœ… Chats loaded');
            } catch (error) {
                console.error('âŒ Load chats error:', error);
            }
        }

        // ==================== Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ Ğ£Ğ§ĞĞ¡Ğ¢ĞĞ˜ĞšĞĞ’ Ğ§ĞĞ¢Ğ ====================
        async function loadChatMembers() {
            try {
                console.log('ğŸ‘¥ Loading chat members from /api/chat/my...');
                
                // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ñ‡Ğ°Ñ‚Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
                const response = await apiRequest('/api/chat/my');
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('âŒ Failed to load chats:', error);
                    showMembersError('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²');
                    return;
                }
                
                const data = await response.json();
                console.log('ğŸ“¦ All chats data:', data);
                
                const chats = data.chats || [];
                
                // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ñ‡Ğ°Ñ‚ Ğ¿Ğ¾ ID
                const currentChat = chats.find(chat => chat.id == chatId);
                console.log('ğŸ” Current chat:', currentChat);
                
                if (!currentChat) {
                    console.error('âŒ Chat not found in user chats');
                    showMembersError('Ğ§Ğ°Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
                    return;
                }
                // ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡Ğ°Ñ‚Ğ°
                const chatName = currentChat.name || `Ğ§Ğ°Ñ‚ #${chatId}`;
                document.getElementById('chatIdDisplay').textContent = chatName;

                // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Ğ¸Ğ· Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°
                const members = currentChat.usernames || currentChat.members || [];
                console.log('ğŸ‘¥ Members found:', members);
                
                // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
                const totalMembersEl = document.getElementById('totalMembers');
                if (totalMembersEl) {
                    totalMembersEl.textContent = members.length;
                }
                
                // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½ (Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ²Ñ‹ Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½)
                const onlineCountEl = document.getElementById('onlineCount');
                if (onlineCountEl) {
                    onlineCountEl.textContent = '1 Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½'; // ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ²Ñ‹ ÑĞ°Ğ¼Ğ¸ Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½
                }
                
                // ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
                displayMembers(members);
                
            } catch (error) {
                console.error('âŒ Error loading members:', error);
                
                // Ğ•ÑĞ»Ğ¸ ÑĞ¾Ğ²ÑĞµĞ¼ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚, Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
                console.log('âš ï¸ Showing fallback with current user only');
                const fallbackMembers = [currentUsername];
                
                const totalMembersEl = document.getElementById('totalMembers');
                if (totalMembersEl) {
                    totalMembersEl.textContent = '1+';
                }
                
                const onlineCountEl = document.getElementById('onlineCount');
                if (onlineCountEl) {
                    onlineCountEl.textContent = '1 Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½';
                }
                
                displayMembers(fallbackMembers);
            }
        }

        // ==================== Ğ£Ğ›Ğ£Ğ§Ğ¨Ğ•ĞĞĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ ĞĞ¢ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ¯ ====================
        function displayMembers(members) {
            const membersListEl = document.getElementById('membersList');
            if (!membersListEl) return;
            
            // Ğ£Ğ±ĞµĞ¶Ğ´Ğ°ĞµĞ¼ÑÑ Ñ‡Ñ‚Ğ¾ members - ÑÑ‚Ğ¾ Ğ¼Ğ°ÑÑĞ¸Ğ²
            if (!Array.isArray(members)) {
                console.warn('âš ï¸ Members is not an array:', members);
                members = [];
            }
            
            if (members.length === 0) {
                membersListEl.innerHTML = `
                    <div class="no-members">
                        <i class="fas fa-user-friends"></i>
                        <p>Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</p>
                        <button onclick="retryLoadMembers()" class="retry-btn" style="margin-top: 1rem;">
                            <i class="fas fa-sync-alt"></i> ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ
                        </button>
                    </div>
                `;
                return;
            }
            
            // âœ… Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğœ onlineUsersSet Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
            const processedMembers = members.map((member, index) => {
                let memberName = '';
                
                if (typeof member === 'string') {
                    memberName = member;
                } else if (typeof member === 'object' && member !== null) {
                    memberName = member.username || member.name || member.user || 'Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº ' + (index + 1);
                } else {
                    memberName = 'Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº ' + (index + 1);
                }
                
                const isCurrentUser = memberName.toLowerCase() === currentUsername.toLowerCase();
                
                // âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¸Ğ· Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¹
                const isOnline = onlineUsersSet.has(memberName.toLowerCase()) || isCurrentUser;
                
                return {
                    username: memberName,
                    status: isOnline ? 'online' : 'offline',
                    isCurrentUser: isCurrentUser,
                    isOnline: isOnline
                };
            });
            
            // Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼: Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ â†’ Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½ â†’ Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½ â†’ Ğ¿Ğ¾ Ğ°Ğ»Ñ„Ğ°Ğ²Ğ¸Ñ‚Ñƒ
            processedMembers.sort((a, b) => {
                if (a.isCurrentUser) return -1;
                if (b.isCurrentUser) return 1;
                if (a.isOnline && !b.isOnline) return -1;
                if (!a.isOnline && b.isOnline) return 1;
                return a.username.localeCompare(b.username, 'ru');
            });
            
            // ĞĞ¢ĞĞ‘Ğ ĞĞ–ĞĞ•Ğœ ĞĞ¢Ğ¡ĞĞ Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞĞ«Ğ¥ Ğ£Ğ§ĞĞ¡Ğ¢ĞĞ˜ĞšĞĞ’
            let html = '';
            
            
            processedMembers.forEach((member) => {
                const avatarColor = generateAvatarColor(member.username);
                const initials = generateAvatarInitials(member.username);
                const statusClass = member.isOnline ? 'online' : 'offline';
                
                let statusText = 'ĞĞµ Ğ² ÑĞµÑ‚Ğ¸';
                if (member.isCurrentUser) {
                    statusText = 'Ğ’ ÑĞµÑ‚Ğ¸';
                } else if (member.isOnline) {
                    statusText = 'Ğ’ ÑĞµÑ‚Ğ¸';
                }
                
                html += `
                    <div class="member-item ${member.isCurrentUser ? 'current-user' : ''}">
                        <div class="member-avatar" style="background: ${avatarColor}; color: white;">
                            ${initials}
                            <span class="online-indicator ${statusClass}"></span>
                        </div>
                        <div class="member-info">
                            <strong>${escapeHtml(member.username)}</strong>
                            <small>${statusText}</small>
                        </div>
                        ${member.isCurrentUser ? '<span class="you-badge">Ğ’Ñ‹</span>' : ''}
                    </div>
                `;
            });
            
            membersListEl.innerHTML = html;
            
            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
            const totalMembersEl = document.getElementById('totalMembers');
            if (totalMembersEl) {
                totalMembersEl.textContent = processedMembers.length;
            }

            // âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
            const onlineCount = processedMembers.filter(m => m.isOnline).length;
            const onlineCountEl = document.getElementById('onlineCount');
            if (onlineCountEl) {
                onlineCountEl.textContent = `${onlineCount} Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½`;
            }
            
            console.log('âœ… Members displayed:', processedMembers.length, 'online:', onlineCount);
        }

        // ==================== ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞĞĞ›ĞĞ™Ğ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡Ğ ====================
        function updateOnlineStatus(users, count) {
            console.log('ğŸ‘¥ Updating online status:', users, count);
            
            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ² ÑˆĞ°Ğ¿ĞºĞµ
            const onlineCountEl = document.getElementById('onlineCount');
            if (onlineCountEl) {
                onlineCountEl.textContent = `${count} Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½`;
            }

            // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ
            onlineUsersSet = new Set(
                (users || []).map(u => {
                    // ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ°: Ğ¾Ğ±ÑŠĞµĞºÑ‚ {username: "name"} Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºÑƒ "name"
                    if (typeof u === 'object' && u !== null) {
                        return (u.username || '').toLowerCase();
                    }
                    return (u || '').toLowerCase();
                })
            );
            
            console.log('ğŸ‘¥ Online usernames set:', [...onlineUsersSet]);

            // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ²ÑĞµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
            const memberItems = document.querySelectorAll('.member-item');
            console.log('ğŸ‘¥ Found member items:', memberItems.length);
            
            if (memberItems.length === 0) {
                console.log('âš ï¸ No member items found, skipping DOM update');
                return;
            }

            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°
            memberItems.forEach(item => {
                const nameEl = item.querySelector('.member-info strong');
                if (!nameEl) {
                    console.log('âš ï¸ No name element found in item');
                    return;
                }

                const memberName = nameEl.textContent.trim();
                const memberNameLower = memberName.toLowerCase();
                const isCurrentUser = memberNameLower === currentUsername.toLowerCase();
                const isOnline = onlineUsersSet.has(memberNameLower);
                
                console.log(`ğŸ‘¤ Checking ${memberName}: isOnline=${isOnline}, isCurrentUser=${isCurrentUser}`);

                // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€
                const indicator = item.querySelector('.online-indicator');
                if (indicator) {
                    // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ ĞºĞ»Ğ°ÑÑÑ‹ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
                    indicator.className = 'online-indicator';
                    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ
                    if (isOnline || isCurrentUser) {
                        indicator.classList.add('online');
                    } else {
                        indicator.classList.add('offline');
                    }
                    console.log(`  â†’ Indicator class: ${indicator.className}`);
                }

                // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
                const statusEl = item.querySelector('.member-info small');
                if (statusEl) {
                    const newStatus = (isOnline || isCurrentUser) ? 'Ğ’ ÑĞµÑ‚Ğ¸' : 'ĞĞµ Ğ² ÑĞµÑ‚Ğ¸';
                    statusEl.textContent = newStatus;
                    console.log(`  â†’ Status text: ${newStatus}`);
                }
            });
            
            // ĞŸĞµÑ€ĞµÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº
            resortMembersList(onlineUsersSet);
            
            console.log('âœ… Online status update complete');
        }

        // ĞŸĞµÑ€ĞµÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° ÑĞ¿Ğ¸ÑĞºĞ° ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
        function resortMembersList(onlineUsernames) {
            const membersListEl = document.getElementById('membersList');
            if (!membersListEl) return;
            
            const items = Array.from(membersListEl.querySelectorAll('.member-item'));
            if (items.length <= 1) return;
            
            items.sort((a, b) => {
                const aName = a.querySelector('.member-info strong')?.textContent.trim().toLowerCase() || '';
                const bName = b.querySelector('.member-info strong')?.textContent.trim().toLowerCase() || '';
                
                const aIsCurrentUser = aName === currentUsername.toLowerCase();
                const bIsCurrentUser = bName === currentUsername.toLowerCase();
                
                // Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹
                if (aIsCurrentUser) return -1;
                if (bIsCurrentUser) return 1;
                
                const aIsOnline = onlineUsernames.has(aName);
                const bIsOnline = onlineUsernames.has(bName);
                
                // ĞĞ½Ğ»Ğ°Ğ¹Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ²Ñ‹ÑˆĞµ Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½
                if (aIsOnline && !bIsOnline) return -1;
                if (!aIsOnline && bIsOnline) return 1;
                
                // ĞĞ»Ñ„Ğ°Ğ²Ğ¸Ñ‚Ğ½Ğ°Ñ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°
                return aName.localeCompare(bName, 'ru');
            });
            
            // ĞŸĞµÑ€ĞµĞ¼ĞµÑ‰Ğ°ĞµĞ¼ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ² Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞµ
            items.forEach(item => membersListEl.appendChild(item));
        }

        // ==================== Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ ====================

        // Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ†Ğ²ĞµÑ‚Ğ° Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ° Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¸Ğ¼ĞµĞ½Ğ¸
        function generateAvatarColor(username) {
            const colors = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)'
            ];
            
            // ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ñ…ĞµÑˆ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¸Ğ¼ĞµĞ½Ğ¸
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            return colors[Math.abs(hash) % colors.length];
        }

        // Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ°
        function generateAvatarInitials(username) {
            if (!username) return '?';
            
            const parts = username.trim().split(' ');
            if (parts.length >= 2) {
                return parts[0][0].toUpperCase() + parts[1][0].toUpperCase();
            }
            return username.substring(0, 2).toUpperCase();
        }

        // ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
        function getStatusText(status, lastSeen, isCurrentUser) {
            if (isCurrentUser) return 'Ğ’ ÑĞµÑ‚Ğ¸';
            
            switch(status) {
                case 'online':
                    return 'Ğ’ ÑĞµÑ‚Ğ¸';
                case 'away':
                    return 'ĞÑ‚Ğ¾ÑˆĞµĞ»';
                case 'busy':
                    return 'ĞĞµ Ğ±ĞµÑĞ¿Ğ¾ĞºĞ¾Ğ¸Ñ‚ÑŒ';
                case 'offline':
                    if (lastSeen) {
                        return `Ğ‘Ñ‹Ğ»(Ğ°) ${formatLastSeen(lastSeen)}`;
                    }
                    return 'ĞĞµ Ğ² ÑĞµÑ‚Ğ¸';
                default:
                    return 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾';
            }
        }

        // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ²Ğ¸Ğ·Ğ¸Ñ‚Ğ°
        function formatLastSeen(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚Ğ¾';
            if (minutes < 60) return `${minutes} Ğ¼Ğ¸Ğ½. Ğ½Ğ°Ğ·Ğ°Ğ´`;
            if (hours < 24) return `${hours} Ñ‡. Ğ½Ğ°Ğ·Ğ°Ğ´`;
            if (days === 1) return 'Ğ²Ñ‡ĞµÑ€Ğ°';
            if (days < 7) return `${days} Ğ´Ğ½. Ğ½Ğ°Ğ·Ğ°Ğ´`;
            
            return date.toLocaleDateString('ru-RU');
        }

        // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
        function showMembersError(message) {
            const membersListEl = document.getElementById('membersList');
            if (membersListEl) {
                membersListEl.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>${message}</p>
                        <button onclick="loadChatMembers()" class="retry-btn">
                            <i class="fas fa-sync-alt"></i> ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ
                        </button>
                    </div>
                `;
            }
        }

        function toggleLeftSidebar() {
            document.querySelector('.chat-list-sidebar').classList.toggle('active');
        }

        function toggleRightSidebar() {
            document.querySelector('.members-sidebar').classList.toggle('active');
        }

        function refreshChatList() {
            loadChatsList();
        }

        window.toggleLeftSidebar = toggleLeftSidebar;
        window.toggleRightSidebar = toggleRightSidebar;
        window.refreshChatList = refreshChatList;

        // ==================== FORM SUBMIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“‹ Chat page DOM ready');
            
            connectWebSocket();
            loadChatsList();
            // âœ… Ğ—ĞĞ“Ğ Ğ£Ğ–ĞĞ•Ğœ Ğ£Ğ§ĞĞ¡Ğ¢ĞĞ˜ĞšĞĞ’ Ğ§ĞĞ¢Ğ
            loadChatMembers();
            
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            
            if (messageForm && messageInput) {
                messageForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const text = messageInput.value.trim();
                    if (!text) {
                        console.log('âš ï¸ Empty message');
                        return;
                    }
                    
                    console.log('ğŸ“¤ Sending:', text);
                    const sendBtn = document.querySelector('.send-btn');
                    if (sendBtn) sendBtn.disabled = true;
                    
                    try {
                        const response = await apiRequest('/api/chat/send', {
                            method: 'POST',
                            body: JSON.stringify({
                                chat_id: parseInt(chatId),
                                text: text
                            })
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Send failed');
                        }
                        
                        messageInput.value = '';
                        messageInput.style.height = '22px';
                        
                        const charCount = document.getElementById('charCount');
                        if (charCount) charCount.textContent = '0';
                        
                        console.log('âœ… Message sent');
                    } catch (error) {
                        console.error('âŒ Send error:', error);
                        alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message);
                    } finally {
                        if (sendBtn) sendBtn.disabled = false;
                        messageInput.focus();
                    }
                });
                
                setTimeout(() => messageInput.focus(), 500);
            }
            
            console.log('âœ… Chat page ready');
        });

        console.log('âœ… Chat script loaded');
    </script>
</body>
</html>