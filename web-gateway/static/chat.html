<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room - Micro Chat</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="chat-app-container">
        <!-- Ğ›ĞµĞ²Ğ°Ñ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ - Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‡Ğ°Ñ‚Ğ¾Ğ² -->
        <aside class="chat-list-sidebar">
            <div class="sidebar-header">
                <button onclick="window.location.href='/'" class="home-btn" title="ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h3>ĞœĞ¾Ğ¸ Ñ‡Ğ°Ñ‚Ñ‹</h3>
                <button onclick="refreshChatList()" class="refresh-btn" title="ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <div class="current-chat-info">
                <div class="chat-status">
                    <span class="status-dot active"></span>
                    <div>
                        <strong>Ğ§Ğ°Ñ‚ #<span id="currentChatId"></span></strong>
                        <small id="connectionStatus">ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾</small>
                    </div>
                </div>
            </div>
            
            <div class="other-chats">
                <div class="section-title">Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ Ñ‡Ğ°Ñ‚Ñ‹</div>
                <div id="chatsList" class="chats-list">
                    <div class="loading-chats">
                        <i class="fas fa-spinner fa-spin"></i>
                        Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ‡Ğ°Ñ‚Ğ¾Ğ²...
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-info-mini">
                    <i class="fas fa-user-circle"></i>
                    <span id="currentUser">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</span>
                </div>
            </div>
        </aside>
        
        <!-- Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ - Ğ§Ğ°Ñ‚ -->
        <main class="chat-main-area">
            <div class="chat-header">
                <button class="mobile-menu-btn" onclick="toggleLeftSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="chat-title">
                    <h2>Ğ§Ğ°Ñ‚ #<span id="chatIdDisplay">...</span></h2>
                    <div class="chat-meta">
                        <span id="messageCount">0 ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹</span>
                        <span class="separator">â€¢</span>
                        <span id="onlineCount">0 Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½</span>
                    </div>
                </div>
                <button class="mobile-members-btn" onclick="toggleRightSidebar()">
                    <i class="fas fa-users"></i>
                </button>
            </div>
            
            <div class="messages-wrapper">
                <div id="messages" class="messages">
                    <div class="welcome-message">
                        <i class="fas fa-comments"></i>
                        <h3>Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ñ‡Ğ°Ñ‚!</h3>
                        <p>ĞĞ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€ÑĞ¼Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ</p>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span class="typing-text">ĞºÑ‚Ğ¾-Ñ‚Ğ¾ Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ°ĞµÑ‚...</span>
                </div>
            </div>
            
            <div class="message-input-area">
                <form id="messageForm" class="message-form">
                    <div class="input-left-actions">
                        <button type="button" class="emoji-btn" title="Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸">
                            <i class="far fa-smile"></i>
                        </button>
                    </div>
                    
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            name="message" 
                            placeholder="ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..."
                            rows="1"
                            maxlength="2000"
                        ></textarea>
                    </div>
                    
                    <div class="input-right-actions">
                        <button type="button" class="input-action-btn" title="ĞŸÑ€Ğ¸ĞºÑ€ĞµĞ¿Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button type="button" class="input-action-btn" title="GIF">
                            <i class="fas fa-gift"></i>
                        </button>
                        <button type="submit" class="send-btn" title="ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
                
                <div class="input-info">
                    <div class="input-hints">
                        <span class="input-hint">
                            <kbd>Enter</kbd> Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ
                        </span>
                        <span class="input-hint">
                            <kbd>Shift</kbd>+<kbd>Enter</kbd> Ğ½Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ°
                        </span>
                    </div>
                    <span class="char-counter">
                        <span id="charCount">0</span>/2000
                    </span>
                </div>
                
                <!-- Emoji Picker -->
                <div class="emoji-picker">
                    <div class="emoji-header">
                        <input type="text" class="emoji-search" placeholder="ĞŸĞ¾Ğ¸ÑĞº ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸...">
                    </div>
                    <div class="emoji-categories">
                        <button type="button" class="emoji-category active">ğŸ˜Š</button>
                        <button type="button" class="emoji-category">ğŸ‘‹</button>
                        <button type="button" class="emoji-category">ğŸŒ¸</button>
                        <button type="button" class="emoji-category">ğŸ•</button>
                        <button type="button" class="emoji-category">âš½</button>
                        <button type="button" class="emoji-category">âœˆï¸</button>
                        <button type="button" class="emoji-category">ğŸ’¡</button>
                        <button type="button" class="emoji-category">â¤ï¸</button>
                    </div>
                    <div class="emoji-grid">
                        <span>ğŸ˜€</span><span>ğŸ˜ƒ</span><span>ğŸ˜„</span><span>ğŸ˜</span>
                        <span>ğŸ˜…</span><span>ğŸ˜‚</span><span>ğŸ¤£</span><span>ğŸ˜Š</span>
                        <span>ğŸ˜‡</span><span>ğŸ™‚</span><span>ğŸ™ƒ</span><span>ğŸ˜‰</span>
                        <span>ğŸ˜Œ</span><span>ğŸ˜</span><span>ğŸ¥°</span><span>ğŸ˜˜</span>
                        <span>ğŸ˜—</span><span>ğŸ˜™</span><span>ğŸ˜š</span><span>ğŸ˜‹</span>
                        <span>ğŸ˜›</span><span>ğŸ˜</span><span>ğŸ˜œ</span><span>ğŸ¤ª</span>
                        <span>ğŸ¤¨</span><span>ğŸ§</span><span>ğŸ¤“</span><span>ğŸ˜</span>
                        <span>ğŸ¤©</span><span>ğŸ¥³</span><span>ğŸ˜</span><span>ğŸ˜’</span>
                        <span>ğŸ˜</span><span>ğŸ˜”</span><span>ğŸ˜Ÿ</span><span>ğŸ˜•</span>
                        <span>ğŸ™</span><span>â˜¹ï¸</span><span>ğŸ˜£</span><span>ğŸ˜–</span>
                        <span>ğŸ˜«</span><span>ğŸ˜©</span><span>ğŸ¥º</span><span>ğŸ˜¢</span>
                        <span>ğŸ˜­</span><span>ğŸ˜¤</span><span>ğŸ˜ </span><span>ğŸ˜¡</span>
                        <span>ğŸ¤¬</span><span>ğŸ¤¯</span><span>ğŸ˜³</span><span>ğŸ¥µ</span>
                        <span>ğŸ¥¶</span><span>ğŸ˜±</span><span>ğŸ˜¨</span><span>ğŸ˜°</span>
                        <span>ğŸ˜¥</span><span>ğŸ˜“</span><span>ğŸ¤—</span><span>ğŸ¤”</span>
                        <span>ğŸ¤­</span><span>ğŸ¤«</span><span>ğŸ¤¥</span><span>ğŸ˜¶</span>
                        <span>ğŸ˜</span><span>ğŸ˜‘</span><span>ğŸ˜¬</span><span>ğŸ™„</span>
                        <span>ğŸ˜¯</span><span>ğŸ˜¦</span><span>ğŸ˜§</span><span>ğŸ˜®</span>
                        <span>ğŸ‘</span><span>ğŸ‘</span><span>ğŸ‘Œ</span><span>âœŒï¸</span>
                        <span>ğŸ¤</span><span>ğŸ¤Ÿ</span><span>ğŸ¤˜</span><span>ğŸ¤™</span>
                        <span>ğŸ‘</span><span>ğŸ™Œ</span><span>ğŸ‘</span><span>ğŸ¤²</span>
                        <span>ğŸ¤</span><span>ğŸ™</span><span>âœï¸</span><span>ğŸ’ª</span>
                        <span>â¤ï¸</span><span>ğŸ§¡</span><span>ğŸ’›</span><span>ğŸ’š</span>
                        <span>ğŸ’™</span><span>ğŸ’œ</span><span>ğŸ–¤</span><span>ğŸ¤</span>
                        <span>ğŸ”¥</span><span>ğŸ’¯</span><span>âœ¨</span><span>â­</span>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- ĞŸÑ€Ğ°Ğ²Ğ°Ñ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ -->
        <aside class="members-sidebar">
            <div class="sidebar-header">
                <h3>Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸</h3>
                <span class="member-count" id="totalMembers">0</span>
            </div>
            
            <div class="members-list" id="membersList">
                <div class="member-item">
                    <div class="member-avatar">
                        <i class="fas fa-user-circle"></i>
                        <span class="online-indicator"></span>
                    </div>
                    <div class="member-info">
                        <strong>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</strong>
                        <small>ĞĞ½Ğ»Ğ°Ğ¹Ğ½</small>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script src="/static/app.js"></script>
    <!-- ĞŸĞµĞ²Ğ°Ñ Ñ‚ĞµĞ¼Ğ° -->
    <!-- <script src="/static/js/animated-background.js"></script> -->
    <!-- Ğ”Ğ»Ñ Liquid Gradient -->
    <script src="/static/js/liquid-gradient.js"></script>

    <!-- Ğ”Ğ»Ñ Starfall -->
    <!-- <script src="/static/js/starfall.js"></script> -->

    <script>
        // ==================== CHAT PAGE LOGIC ====================
        console.log('ğŸ® Chat page script loading...');
        
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('id');
        
        if (!chatId) {
            alert('âŒ Chat ID Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½!');
            window.location.href = '/';
            throw new Error('No chat ID');
        }

        if (!TokenManager.isAuthenticated()) {
            alert('âŒ ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ!');
            window.location.href = '/';
            throw new Error('Not authenticated');
        }

        console.log('âœ… Chat ID:', chatId);
        
        const token = TokenManager.getAccessToken();
        const currentUsername = TokenManager.getUsername() || 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ';
        let messageCount = 0;

        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ID ÑÑ€Ğ°Ğ·Ñƒ
        document.getElementById('currentChatId').textContent = chatId;
        document.getElementById('chatIdDisplay').textContent = chatId;
        document.getElementById('currentUser').textContent = currentUsername;

        // ==================== WEBSOCKET ====================
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const cleanToken = token.replace('Bearer ', '').trim();
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/chat/${chatId}?token=${encodeURIComponent(cleanToken)}`;
        
        console.log('ğŸ”Œ Connecting to:', wsUrl.replace(cleanToken, 'TOKEN'));
        
        function connectWebSocket() {
            window.socket = new WebSocket(wsUrl);
            
            window.socket.onopen = () => {
                console.log('âœ… WebSocket connected');
                updateConnectionStatus(true);
            };

            window.socket.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    console.log('ğŸ“¨ Message:', msg);
                    
                    if (msg.error) {
                        console.error('âŒ Error:', msg.error);
                        return;
                    }
                    
                    displayMessage(msg);
                } catch (error) {
                    console.error('âŒ Parse error:', error);
                }
            };

            window.socket.onerror = (error) => {
                console.error('âŒ WebSocket error:', error);
                updateConnectionStatus(false);
            };

            window.socket.onclose = () => {
                console.log('ğŸ”Œ Closed, reconnecting...');
                updateConnectionStatus(false);
                setTimeout(connectWebSocket, 3000);
            };
        }

        function displayMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const welcome = messagesDiv.querySelector('.welcome-message');
            if (welcome) welcome.remove();
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            
            const isOwn = msg.from === currentUsername;
            if (isOwn) msgDiv.classList.add('own');
            
            const textLength = msg.text ? msg.text.length : 0;
            let sizeClass = '';
            if (textLength <= 3) sizeClass = 'tiny';
            else if (textLength <= 20) sizeClass = 'short';
            else if (textLength > 200) sizeClass = 'long';
            
            const timeStr = new Date().toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            msgDiv.innerHTML = `
                <div class="message-header">
                    <strong>${escapeHtml(msg.from)}</strong>
                    <span class="time">${timeStr}</span>
                </div>
                <div class="message-text ${sizeClass}">${escapeHtml(msg.text || '')}</div>
            `;
            
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            messageCount++;
            document.getElementById('messageCount').textContent = `${messageCount} ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateConnectionStatus(isConnected) {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.getElementById('connectionStatus');
            const sendBtn = document.querySelector('.send-btn');
            
            if (isConnected) {
                if (statusDot) statusDot.classList.add('active');
                if (statusText) statusText.textContent = 'ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾';
                if (sendBtn) sendBtn.disabled = false;
            } else {
                if (statusDot) statusDot.classList.remove('active');
                if (statusText) statusText.textContent = 'ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾';
                if (sendBtn) sendBtn.disabled = true;
            }
        }

        async function loadChatsList() {
            try {
                const response = await apiRequest('/api/chat/my');
                const data = await response.json();
                
                if (!response.ok) {
                    console.error('Load chats failed:', data.error);
                    return;
                }
                
                let chats = data.chats || [];
                chats = chats.filter(chat => chat && chat.id && chat.id != chatId);
                
                const chatsListEl = document.getElementById('chatsList');
                
                if (chats.length === 0) {
                    chatsListEl.innerHTML = '<p class="no-chats">ĞĞµÑ‚ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ñ‡Ğ°Ñ‚Ğ¾Ğ²</p>';
                    return;
                }
                
                let html = '';
                chats.forEach(chat => {
                    const users = chat.usernames || [];
                    html += `
                        <a href="/chat?id=${chat.id}" class="chat-item">
                            <div class="chat-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="chat-info">
                                <strong>Ğ§Ğ°Ñ‚ #${chat.id}</strong>
                                <small>${users.slice(0, 2).join(', ')}${users.length > 2 ? '...' : ''}</small>
                            </div>
                        </a>
                    `;
                });
                
                chatsListEl.innerHTML = html;
                console.log('âœ… Chats loaded');
            } catch (error) {
                console.error('âŒ Load chats error:', error);
            }
        }

        function toggleLeftSidebar() {
            document.querySelector('.chat-list-sidebar').classList.toggle('active');
        }

        function toggleRightSidebar() {
            document.querySelector('.members-sidebar').classList.toggle('active');
        }

        function refreshChatList() {
            loadChatsList();
        }

        window.toggleLeftSidebar = toggleLeftSidebar;
        window.toggleRightSidebar = toggleRightSidebar;
        window.refreshChatList = refreshChatList;

        // ==================== FORM SUBMIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“‹ Chat page DOM ready');
            
            connectWebSocket();
            loadChatsList();
            
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            
            if (messageForm && messageInput) {
                messageForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const text = messageInput.value.trim();
                    if (!text) {
                        console.log('âš ï¸ Empty message');
                        return;
                    }
                    
                    console.log('ğŸ“¤ Sending:', text);
                    const sendBtn = document.querySelector('.send-btn');
                    if (sendBtn) sendBtn.disabled = true;
                    
                    try {
                        const response = await apiRequest('/api/chat/send', {
                            method: 'POST',
                            body: JSON.stringify({
                                chat_id: parseInt(chatId),
                                text: text
                            })
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Send failed');
                        }
                        
                        messageInput.value = '';
                        messageInput.style.height = '22px';
                        
                        const charCount = document.getElementById('charCount');
                        if (charCount) charCount.textContent = '0';
                        
                        console.log('âœ… Message sent');
                    } catch (error) {
                        console.error('âŒ Send error:', error);
                        alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message);
                    } finally {
                        if (sendBtn) sendBtn.disabled = false;
                        messageInput.focus();
                    }
                });
                
                setTimeout(() => messageInput.focus(), 500);
            }
            
            console.log('âœ… Chat page ready');
        });

        console.log('âœ… Chat script loaded');
    </script>
</body>
</html>